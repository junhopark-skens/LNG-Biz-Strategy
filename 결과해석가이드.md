# GenCast 결과 해석 가이드

이 문서는 GenCast 모델의 예측 결과를 해석하는 방법을 상세히 설명합니다.

## 목차
1. [기본 개념](#기본-개념)
2. [출력 데이터 구조](#출력-데이터-구조)
3. [시각화 해석](#시각화-해석)
4. [평가 지표](#평가-지표)
5. [실전 예시](#실전-예시)
6. [고급 분석](#고급-분석)

---

## 기본 개념

### 앙상블 예측이란?

GenCast는 **확률론적 예측(Probabilistic Forecasting)**을 수행합니다. 단일 예측 대신, 여러 개의 가능한 미래 시나리오를 생성합니다.

```
단일 예측: "내일 기온은 20°C입니다"
앙상블 예측: "내일 기온은 18-22°C 범위일 확률이 80%입니다"
```

**장점:**
- 불확실성을 정량화
- 극한 기상 현상의 위험도 평가
- 더 신뢰할 수 있는 의사결정 지원

### GenCast의 예측 프로세스

1. **입력**: 과거 2개 시점의 날씨 데이터 (12시간 간격)
2. **처리**: Diffusion model로 노이즈를 제거하며 예측 생성
3. **출력**: 여러 앙상블 멤버 (보통 8-50개)
4. **자기회귀**: 이전 예측을 다음 예측의 입력으로 사용하여 장기 예보 생성

---

## 출력 데이터 구조

### 1. Predictions (예측)

**구조:**
```python
predictions.dims = {
    'sample': 8,      # 앙상블 멤버 수
    'time': 10,       # 예측 시간 단계 (12시간 간격)
    'lat': 180,       # 위도
    'lon': 360,       # 경도
    'level': 13       # 기압 고도 (일부 변수만)
}
```

**의미:**
- 각 `sample`은 독립적인 미래 시나리오
- 모든 샘플은 동일하게 그럴듯한 예측
- 샘플 간 차이가 클수록 불확실성이 큼

### 2. Targets (실제 값)

**구조:**
```python
targets.dims = {
    'time': 10,       # 예측과 동일한 시간
    'lat': 180,
    'lon': 360,
    'level': 13
}
```

**의미:**
- ERA5 재분석 데이터 (실제 관측의 최선 추정치)
- 모델 평가의 "정답"
- 과거 데이터에서만 사용 가능 (실시간 예보에서는 없음)

### 3. Ensemble Mean (앙상블 평균)

**계산:**
```python
ensemble_mean = predictions.mean(dim='sample')
```

**의미:**
- 모든 앙상블 멤버의 평균
- **가장 신뢰할 수 있는 단일 예측 값**
- 극값보다는 중심 경향을 나타냄

### 4. Diff (차이)

**계산:**
```python
diff = predictions - targets
```

**해석:**
- **양수 (빨간색)**: 모델이 과대 예측
- **음수 (파란색)**: 모델이 과소 예측
- **0에 가까움 (흰색)**: 정확한 예측

---

## 시각화 해석

### 컬러맵 이해하기

#### 1. 날씨 변수 시각화 (Viridis)

![Viridis colormap]

- **보라색/파란색**: 낮은 값
- **초록색/노란색**: 중간 값
- **노란색**: 높은 값

**예시: 2m_temperature**
- 보라색 = 낮은 기온 (추움)
- 노란색 = 높은 기온 (더움)

#### 2. 차이 시각화 (RdBu_r)

![RdBu_r colormap]

- **빨간색**: 양수 차이 (과대 예측)
- **흰색**: 0 (정확)
- **파란색**: 음수 차이 (과소 예측)

### 애니메이션 읽기

노트북의 시각화는 시간에 따라 변화하는 애니메이션입니다:

```
제목: 2m_temperature, 48h
     ↑ 변수명      ↑ 예측 시점 (48시간 후)
```

**팁:**
- 애니메이션을 멈추고 특정 시점 관찰
- 공간적 패턴과 시간적 변화 모두 확인
- 여러 변수를 비교하여 일관성 확인

---

## 평가 지표

### CRPS (Continuous Ranked Probability Score)

**정의:**
앙상블 예측과 실제 값 사이의 차이를 측정하는 지표

**수식:**
```
CRPS = E[|예측 - 실제|] - 0.5 * E[|예측1 - 예측2|]
       ↑ 정확도           ↑ 앙상블 분산 패널티
```

**해석:**
- **0**: 완벽한 예측
- **낮은 값 (< 1)**: 좋은 예측 ✅
- **높은 값 (> 5)**: 나쁜 예측 ❌
- **단위**: 예측 변수와 동일 (예: 기온이면 K)

**CRPS vs MAE (평균 절대 오차):**
- MAE는 단일 예측의 오차만 측정
- CRPS는 앙상블의 불확실성도 반영
- CRPS가 더 엄격하고 포괄적인 지표

### 시각적 CRPS 해석

```
CRPS 맵에서:
- 육지에서 높음 → 지형/대기 복잡성
- 해양에서 낮음 → 상대적으로 단순
- 고위도에서 높음 → 극지방 예측 어려움
- 저위도에서 낮음 → 열대는 상대적으로 예측 쉬움
```

---

## 실전 예시

### 예시 1: 2m Temperature (지상 기온)

**노트북 출력:**
```
Targets:        평균 293K (약 20°C)
Ensemble Mean:  평균 292K (약 19°C)
Diff:           -1K (파란색 영역)
CRPS:           0.8K
```

**해석:**
1. 모델이 약 1도 낮게 예측
2. CRPS 0.8K는 우수한 수준
3. 앙상블 멤버들의 일관성 높음
4. **결론**: 신뢰할 수 있는 예측

**실용적 의미:**
- 기온 예보에 사용 가능
- ±1°C 정도의 오차 범위 예상
- 극한 기온 이벤트는 앙상블 분산 확인 필요

### 예시 2: Geopotential at 500hPa

**노트북 출력:**
```
Targets:        복잡한 파동 패턴
Ensemble Mean:  유사한 패턴, 약간 smooth
Diff:           작은 위상 차이
CRPS:           50 m²/s²
```

**해석:**
1. 대기 파동의 위치를 거의 정확히 예측
2. 약간의 위상 지연 또는 진행 속도 차이
3. 전반적으로 좋은 예측

**실용적 의미:**
- 상층 대기 패턴 이해
- 제트기류 위치 예측
- 날씨 시스템의 이동 경로 추적

### 예시 3: Total Precipitation (강수량)

**노트북 출력:**
```
Targets:        국지적인 강수 영역
Predictions:    더 넓게 분산된 강수
CRPS:           높음 (> 0.001m)
```

**해석:**
1. 강수는 가장 예측하기 어려운 변수
2. 위치와 강도 모두 불확실성 높음
3. 앙상블 분산 큼 → 확률적 접근 필요

**실용적 의미:**
- 단일 예측보다 앙상블 전체 활용
- "어느 멤버든 비가 온다" → 비 올 확률 높음
- "모든 멤버가 비" → 확실히 비 예상

---

## 고급 분석

### 1. 앙상블 분산 분석

**목적:** 예측 불확실성 정량화

**방법:**
```python
ensemble_std = predictions.std(dim='sample')
```

**해석:**
- **낮은 분산**: 모든 멤버가 동의 → 높은 확신
- **높은 분산**: 멤버들이 분산 → 낮은 확신

**활용:**
```
if ensemble_std > threshold:
    print("불확실성 높음 → 추가 관측 필요")
else:
    print("확신 높음 → 신뢰 가능")
```

### 2. 시간에 따른 오차 증가

**관찰:**
- 초기 시간 (12-24h): 매우 정확
- 중기 (36-72h): 여전히 좋음
- 장기 (120h+): 오차 증가

**CRPS 시간 그래프:**
```
CRPS
  ↑
  |              ___---
  |          __--
  |      __--
  |  __--
  +------------------→ 예측 시간
  0h   24h   72h  120h
```

**의미:** 카오스 이론의 나비효과
- 초기 조건의 작은 오차가 시간에 따라 증가
- 장기 예보일수록 확률적 해석 중요

### 3. 지역별 성능 차이

**패턴:**
- **열대**: CRPS 낮음 (예측 쉬움)
- **중위도**: CRPS 중간 (변동성 높음)
- **극지방**: CRPS 높음 (관측 부족, 복잡)

**지형 영향:**
- **평평한 해양**: 예측 우수
- **산악 지역**: 예측 어려움
- **도시 지역**: 국지 효과로 인한 오차

### 4. 극한 기상 예측

**극한 이벤트 탐지:**
```python
# 어느 멤버든 임계값 초과?
extreme_prob = (predictions > threshold).mean(dim='sample')
```

**해석:**
- `extreme_prob = 0.8` → 80% 확률로 극한 이벤트
- `extreme_prob = 0.2` → 20% 확률 (낮지만 무시 못함)

**의사결정:**
```
if extreme_prob > 0.3:
    print("경보 발령 고려")
    print("방재 준비 강화")
```

---

## 변수별 특성 및 해석 팁

### 기온 (2m_temperature)

**특성:**
- 비교적 예측 쉬움
- 공간적으로 부드러운 변화
- 일변화 패턴 명확

**해석 포인트:**
- 켈빈(K) → 섭씨(°C) 변환: `°C = K - 273.15`
- 육지/해양 차이 확인
- 전선 위치에서 급격한 변화

### 지오포텐셜 (geopotential)

**특성:**
- 상층 대기 흐름 표현
- 500hPa가 가장 중요 (약 5.5km 고도)
- 기압골/기압마루 패턴

**해석 포인트:**
- 파동 패턴의 진폭과 위상
- 제트기류와 연관
- 날씨 시스템의 이동 경로 예측

### 바람 (10m_u/v_component_of_wind)

**특성:**
- u: 동서 방향 (양수 = 서→동)
- v: 남북 방향 (양수 = 남→북)
- 벡터 합성으로 풍속/풍향 계산

**해석 포인트:**
```python
wind_speed = np.sqrt(u**2 + v**2)
wind_direction = np.arctan2(v, u) * 180 / np.pi
```

### 강수량 (total_precipitation_12hr)

**특성:**
- 가장 예측 어려운 변수
- 국지적, 간헐적 발생
- 앙상블 분산 큼

**해석 포인트:**
- 확률적 접근 필수
- 누적 강수량 단위: m (미터!)
- 0.001m = 1mm 강수

### 기압 (mean_sea_level_pressure)

**특성:**
- 고기압/저기압 시스템
- 날씨 패턴의 핵심 지표

**해석 포인트:**
- 단위: Pa (파스칼)
- 1013 hPa = 101300 Pa (평균 해수면 기압)
- 저기압 = 나쁜 날씨, 고기압 = 좋은 날씨 (일반적으로)

---

## 체크리스트: 좋은 예측 판단하기

### ✅ 정량적 기준

- [ ] CRPS < 1.0 (기온의 경우)
- [ ] Ensemble Mean과 Targets의 공간 패턴 유사
- [ ] Diff 맵에서 체계적 편향 없음 (빨강/파랑 균형)
- [ ] 시간에 따라 점진적으로 오차 증가 (급격한 발산 없음)

### ✅ 정성적 기준

- [ ] 기상학적으로 그럴듯한 패턴
- [ ] 물리적 일관성 (예: 저기압 중심에 상승 기류)
- [ ] 여러 변수 간 상관관계 유지
- [ ] 극한값이 현실적인 범위 내

### ❌ 경고 신호

- [ ] CRPS가 비정상적으로 높음
- [ ] Ensemble 멤버들이 완전히 다른 시나리오
- [ ] 체계적 편향 (항상 과대/과소 예측)
- [ ] 물리적으로 불가능한 값 (예: 음수 강수량)

---

## 다음 단계

### 심화 학습

1. **ERA5 데이터셋 이해**
   - [ECMWF ERA5 문서](https://www.ecmwf.int/en/forecasts/dataset/ecmwf-reanalysis-v5)

2. **확률론적 예측 이론**
   - CRPS, Brier Score 등 평가 지표
   - Ensemble calibration

3. **기상학 기초**
   - 대기 역학
   - 수치 예보 모델링

### 실습 아이디어

1. **특정 지역 추출**
   ```python
   korea = predictions.sel(lat=slice(33, 43), lon=slice(124, 132))
   ```

2. **시계열 분석**
   ```python
   seoul_temp = predictions.sel(lat=37.5, lon=127, method='nearest')
   seoul_temp.plot.line(x='time', hue='sample')
   ```

3. **극한 이벤트 확률**
   ```python
   heat_wave_prob = (predictions['2m_temperature'] > 308.15).mean(dim='sample')
   # 308.15K = 35°C
   ```

---

## 참고 문헌

- Price, I., et al. (2024). "GenCast: Diffusion-based ensemble forecasting for medium-range weather". *Nature*. [링크](https://www.nature.com/articles/s41586-024-08252-9)
- Gneiting, T., & Raftery, A. E. (2007). "Strictly proper scoring rules, prediction, and estimation". *Journal of the American statistical Association*.
- ECMWF. (2023). "ECMWF Ensemble Prediction System". [문서](https://www.ecmwf.int/en/forecasts/documentation-and-support/evolution-ifs/cycles/summary-cycle-48r1)

---

**작성일**: 2025-12-01
**버전**: 1.0
